<!-- PWA Install Prompt + Offline hint -->
<script>
  // ────────────────────────────────────────────────
  // Config
  // ────────────────────────────────────────────────
  const STORAGE_KEY = "pbiss_install_prompt_dismissed_v3";
  const DAYS_TO_REMIND = 14; // optional: remind after X days if dismissed

  // Already decided or recently dismissed → skip
  if (localStorage.getItem(STORAGE_KEY)) {
    const dismissedAt = localStorage.getItem(STORAGE_KEY);
    if (Date.now() - dismissedAt < DAYS_TO_REMIND * 24 * 60 * 60 * 1000) {
      return; // don't show again for 2 weeks
    }
  }

  let deferredPrompt = null;
  const isLikelyIOS = /iphone|ipad|ipod/i.test(navigator.userAgent) ||
                     (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);

  // ─── Show prompt after some interaction (better UX than on load) ───
  function showInstallPrompt() {
    const promptShown = document.createElement("div");
    promptPrompt.id = "pwa-install-toast";
    promptPrompt.style.cssText = `
      position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
      background: #997516; color: white; padding: 16px 24px;
      border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      z-index: 9999; max-width: 90%; text-align: center;
      font-family: system-ui; backdrop-filter: blur(8px);
    `;

    promptPrompt.innerHTML = `
      <p style="margin:0 0 12px">Add PBISS Pickup to your home screen for faster access<br>(works offline too!)</p>
      ${isLikelyIOS ? 
        'Tap <b>Share</b> → <b>Add to Home Screen</b>' : 
        '<button id="installBtn" style="background:white;color:#997516;padding:10px 20px;border:none;border-radius:8px;font-weight:bold;cursor:pointer">Install Now</button>'}
      <button id="dismissBtn" style="margin-left:16px;background:transparent;color:white;border:none;opacity:0.8">× Later</button>
    `;

    document.body.appendChild(promptPrompt);

    const installBtn = document.getElementById("installBtn");
    const dismissBtn = document.getElementById("dismissBtn");

    if (installBtn) {
      installBtn.onclick = async () => {
        if (deferredPrompt) {
          deferredPrompt.prompt();
          const { outcome } = await deferredPrompt.userChoice;
          if (outcome === "accepted") {
            // Optional: track install success
          }
        }
        cleanupAndRemember();
      };
    }

    dismissBtn.onclick = cleanupAndRemember;

    function cleanupAndRemember() {
      promptPrompt.remove();
      localStorage.setItem(STORAGE_KEY, Date.now());
    }
  }

  // ─── Native prompt (Android/Chrome) ───
  window.addEventListener("beforeinstallprompt", (e) => {
    e.preventDefault();
    deferredPrompt = e;
    setTimeout(showInstallPrompt, 8000); // show after ~8s of usage
  });

  // iOS: show after some time if no native prompt
  if (isLikelyIOS) {
    setTimeout(showInstallPrompt, 12000);
  }
</script>
